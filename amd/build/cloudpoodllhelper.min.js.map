{"version":3,"file":"cloudpoodllhelper.min.js","sources":["../src/cloudpoodllhelper.js"],"sourcesContent":["define([\"jquery\", \"core/log\", \"qtype_cloudpoodll/cloudpoodllloader\"], function ($, log, cloudpoodll) {\n    \"use strict\"; // jshint ;_;\n\n    log.debug(\"cloudpoodll helper: initialising\");\n\n    return {\n\n        configs: {},\n\n        init: function (opts) {\n            var config ={};\n            config.component = opts[\"component\"];\n            config.data_id = opts[\"data_id\"];\n            config.inputname = opts[\"inputname\"];\n            config.transcriber = opts[\"transcriber\"];\n            config.uploadstate= false;\n            config.safesave = opts[\"safesave\"];\n\n            //register controls\n            var name = CSS.escape(config.inputname);\n            config.controls = {\n                nextpagebtn: $(\".submitbtns .mod_quiz-next-nav\"),\n                mediaurl: $(\"input[name=\" + name + \"mediaurl]\"),\n                transcript: $(\"input[name=\" + name + \"transcript]\"),\n                answer: $(\"input[name=\" + name + \"]\"),\n            };\n            this.configs[config.data_id] = config;\n            var that=this;\n\n            //setup recorder\n            var gspeech = \"\";\n\n            cloudpoodll.init(config.data_id, function (evt) {\n                var theconfig=that.configs[evt.id];\n                //we need to only do our event (not another recorder on this page)\n                if (!theconfig){return;}\n\n                switch (evt.type) {\n                    case \"recording\":\n                        if (evt.action === \"started\") {\n                            gspeech = \"\";\n                            // post a custom event that a filter template might be interested in\n                            var cpquestionStarted = new CustomEvent(\"cpquestionStarted\", {details: evt});\n                            document.dispatchEvent(cpquestionStarted);\n\n                            //if opts safe save\n                            if(theconfig.safesave==1) {\n                                theconfig.controls.nextpagebtn.attr('disabled', 'disabled');\n                                //Add a page unload check ..\n                                $(window).on('beforeunload', that.preventPrematureLeaving);\n                            }\n                        }\n                        break;\n                    case \"speech\":\n                        gspeech += \"  \" + evt.capturedspeech;\n                        theconfig.controls.transcript.val(gspeech);\n                        theconfig.controls.answer.val(gspeech);\n                        break;\n                    case \"awaitingprocessing\":\n                        if (theconfig.uploadstate != \"posted\") {\n                            theconfig.controls.mediaurl.val(evt.mediaurl);\n                            theconfig.controls.answer.val(evt.mediaurl);\n\n                            // post a custom event that a filter template might be interested in\n                            var cpquestionUploaded = new CustomEvent(\"cpquestionUploaded\", {details: evt});\n                            document.dispatchEvent(cpquestionUploaded);\n\n                            //if opts safe save\n                            if(theconfig.safesave==1) {\n                                theconfig.controls.nextpagebtn.removeAttr('disabled', 'disabled');\n                                //deactivate premature leaving\n                                $(window).off('beforeunload', that.preventPrematureLeaving);\n                            }\n                        }\n                        theconfig.uploadstate = \"posted\";\n                        break;\n                    case \"error\":\n                        alert(\"PROBLEM: \" + evt.message);\n                        break;\n                }\n            }//end of callback function\n\n            );//end of cp init\n\n        },\n        preventPrematureLeaving: function(e){\n            log.debug('preventPrematureLeaving has been called');\n            e.preventDefault();\n            return e.returnValue = \"Your recording has not been uploaded. Cancel to stay on this page.\";\n        },\n\n        register_events: function (config) {\n            //nothing here\n        }\n    };//end of return object\n});"],"names":["define","$","log","cloudpoodll","debug","configs","init","opts","config","component","data_id","inputname","transcriber","uploadstate","safesave","name","CSS","escape","controls","nextpagebtn","mediaurl","transcript","answer","that","this","gspeech","evt","theconfig","id","type","action","cpquestionStarted","CustomEvent","details","document","dispatchEvent","attr","window","on","preventPrematureLeaving","capturedspeech","val","cpquestionUploaded","removeAttr","off","alert","message","e","preventDefault","returnValue","register_events"],"mappings":"AAAAA,6CAAO,CAAC,SAAU,WAAY,wCAAwC,SAAUC,EAAGC,IAAKC,oBAGpFD,IAAIE,MAAM,oCAEH,CAEHC,QAAS,GAETC,KAAM,SAAUC,UACRC,OAAQ,GACZA,OAAOC,UAAYF,KAAI,UACvBC,OAAOE,QAAUH,KAAI,QACrBC,OAAOG,UAAYJ,KAAI,UACvBC,OAAOI,YAAcL,KAAI,YACzBC,OAAOK,aAAa,EACpBL,OAAOM,SAAWP,KAAI,aAGlBQ,KAAOC,IAAIC,OAAOT,OAAOG,WAC7BH,OAAOU,SAAW,CACdC,YAAalB,EAAE,kCACfmB,SAAUnB,EAAE,cAAgBc,KAAO,aACnCM,WAAYpB,EAAE,cAAgBc,KAAO,eACrCO,OAAQrB,EAAE,cAAgBc,KAAO,WAEhCV,QAAQG,OAAOE,SAAWF,WAC3Be,KAAKC,KAGLC,QAAU,GAEdtB,YAAYG,KAAKE,OAAOE,SAAS,SAAUgB,SACnCC,UAAUJ,KAAKlB,QAAQqB,IAAIE,OAE1BD,iBAEGD,IAAIG,UACH,eACkB,YAAfH,IAAII,OAAsB,CAC1BL,QAAU,OAENM,kBAAoB,IAAIC,YAAY,oBAAqB,CAACC,QAASP,MACvEQ,SAASC,cAAcJ,mBAGA,GAApBJ,UAAUb,WACTa,UAAUT,SAASC,YAAYiB,KAAK,WAAY,YAEhDnC,EAAEoC,QAAQC,GAAG,eAAgBf,KAAKgB,oCAIzC,SACDd,SAAW,KAAOC,IAAIc,eACtBb,UAAUT,SAASG,WAAWoB,IAAIhB,SAClCE,UAAUT,SAASI,OAAOmB,IAAIhB,mBAE7B,wBAC4B,UAAzBE,UAAUd,YAAyB,CACnCc,UAAUT,SAASE,SAASqB,IAAIf,IAAIN,UACpCO,UAAUT,SAASI,OAAOmB,IAAIf,IAAIN,cAG9BsB,mBAAqB,IAAIV,YAAY,qBAAsB,CAACC,QAASP,MACzEQ,SAASC,cAAcO,oBAGA,GAApBf,UAAUb,WACTa,UAAUT,SAASC,YAAYwB,WAAW,WAAY,YAEtD1C,EAAEoC,QAAQO,IAAI,eAAgBrB,KAAKgB,0BAG3CZ,UAAUd,YAAc,mBAEvB,QACDgC,MAAM,YAAcnB,IAAIoB,cAQxCP,wBAAyB,SAASQ,UAC9B7C,IAAIE,MAAM,2CACV2C,EAAEC,iBACKD,EAAEE,YAAc,sEAG3BC,gBAAiB,SAAU1C"}